<% layout("/layouts/boilerplate") %>

<style>
  .metric-card {
    border-left: 4px solid #0d6efd;
    background: white;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: #0d6efd;
  }
  .chart-container {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
  }
</style>

<div class="container mt-4">
  <h2 class="mb-4"><i class="fa-solid fa-chart-line"></i> ML Performance Dashboard</h2>

  <div class="row">
    <!-- Top Metrics Cards -->
    <div class="col-md-3">
      <div class="metric-card">
        <h6 class="text-muted">Bandit vs Baseline CTR</h6>
        <div class="metric-value" id="ctr-diff">+12.3%</div>
        <small class="text-success"><i class="fa-solid fa-arrow-up"></i> Bandit performing better</small>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="metric-card">
        <h6 class="text-muted">Exploration Rate</h6>
        <div class="metric-value" id="explore-rate">23%</div>
        <small>Still discovering new listings</small>
      </div>
    </div>

    <div class="col-md-3">
      <div class="metric-card">
        <h6 class="text-muted">Sentiment Trend</h6>
        <div class="metric-value" id="sentiment-trend">+8%</div>
        <small class="text-success">More positive reviews this week</small>
      </div>
    </div>

    <div class="col-md-3">
      <div class="metric-card">
        <h6 class="text-muted">Revenue Lift</h6>
        <div class="metric-value" id="revenue-lift">₹45K</div>
        <small>From ML recommendations</small>
      </div>
    </div>
  </div>

  <!-- Performance Chart -->
  <div class="chart-container">
    <h5>CTR Over Time (MAB vs Random Baseline)</h5>
    <canvas id="ctrChart" height="80"></canvas>
  </div>

  <!-- Algorithm Comparison -->
  <div class="row">
    <div class="col-md-6">
      <div class="chart-container">
        <h5>Exploration vs Exploitation</h5>
        <canvas id="exploreChart"></canvas>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="chart-container">
        <h5>Sentiment Distribution</h5>
        <canvas id="sentimentChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Top Recommended Listings -->
  <div class="table-responsive mt-4">
    <h5 class="mb-3">Top Recommended Listings (ML-powered)</h5>
    <table class="table table-hover">
      <thead class="table-dark">
        <tr>
          <th>Listing</th>
          <th>Expected Reward</th>
          <th>Confidence</th>
          <th>Factors</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="top-listings">
        <!-- Populated by JS -->
      </tbody>
    </table>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Fetch ML analytics data
  async function loadMLDashboard() {
    try {
      const resp = await fetch('/admin/ml/analytics');
      const data = await resp.json();
      if (!data || !data.success) {
        console.error('Failed to load ML analytics:', data.error);
        return;
      }

      // Update metric cards
      if (data.ctrDiff !== undefined) {
        const ctrElement = document.getElementById('ctr-diff');
        if (ctrElement) {
          const sign = data.ctrDiff >= 0 ? '+' : '';
          ctrElement.textContent = `${sign}${data.ctrDiff.toFixed(1)}%`;
          ctrElement.parentElement.querySelector('small').className = data.ctrDiff >= 0 ? 'text-success' : 'text-danger';
        }
      }
      if (data.explorationRate !== undefined) {
        const exploreElement = document.getElementById('explore-rate');
        if (exploreElement) exploreElement.textContent = `${(data.explorationRate*100).toFixed(0)}%`;
      }
      if (data.sentimentTrend !== undefined) {
        const sentimentElement = document.getElementById('sentiment-trend');
        if (sentimentElement) {
          const sign = data.sentimentTrend >= 0 ? '+' : '';
          sentimentElement.textContent = `${sign}${(data.sentimentTrend*100).toFixed(0)}%`;
        }
      }
      if (data.revenueLift !== undefined) {
        const revenueElement = document.getElementById('revenue-lift');
        if (revenueElement) {
          if (data.revenueLift >= 1000) {
            revenueElement.textContent = `₹${(data.revenueLift/1000).toFixed(1)}K`;
          } else {
            revenueElement.textContent = `₹${data.revenueLift.toFixed(0)}`;
          }
        }
      }

      // Populate top listings
      if (data.topListings && Array.isArray(data.topListings) && data.topListings.length > 0) {
        const tbody = document.getElementById('top-listings');
        if (tbody) {
          tbody.innerHTML = data.topListings.map(l => `
            <tr>
              <td><strong>${l.title || 'Unknown'}</strong></td>
              <td><span class="badge bg-success">${(l.expectedReward*100).toFixed(0)}%</span></td>
              <td><span class="badge bg-${l.confidence === 'high' ? 'success' : (l.confidence === 'medium' ? 'warning' : 'secondary')}">${l.confidence}</span></td>
              <td><small>${(l.factors || []).map(f => f.message).slice(0,2).join('; ')}</small></td>
              <td><a href="/listings/${l.id}" class="btn btn-sm btn-outline-primary">View</a></td>
            </tr>
          `).join('');
        }
      } else {
        const tbody = document.getElementById('top-listings');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No data available yet. Start using the platform to see ML recommendations.</td></tr>';
        }
      }

      // Initialize exploration and sentiment charts with real data
      if (data.explorationData) {
        initializeExplorationChart(data.explorationData);
      }
      if (data.sentimentDistribution) {
        initializeSentimentChart(data.sentimentDistribution);
      }

      // Update CTR chart with real data
      if (data.ctrData && data.ctrData.overTime) {
        updateCTRChart(data.ctrData.overTime);
      }

    } catch(e) {
      console.error('Failed to load ML dashboard:', e);
    }
  }

  // CTR Chart - will be initialized with real data
  let ctrChart = null;

  function updateCTRChart(ctrOverTime) {
    const ctrData = {
      labels: ctrOverTime.labels || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
      datasets: [
        {
          label: 'MAB Algorithm',
          data: ctrOverTime.mab || [],
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13, 110, 253, 0.1)',
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: true
        },
        {
          label: 'Random Baseline',
          data: ctrOverTime.random || [],
          borderColor: '#6c757d',
          backgroundColor: 'rgba(108, 117, 125, 0.1)',
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: true
        }
      ]
    };

    // Calculate proper scale limits dynamically
    const allValues = [...(ctrOverTime.mab || []), ...(ctrOverTime.random || [])];
    const maxValue = allValues.length > 0 ? Math.max(...allValues) : 0.03;
    const minValue = allValues.length > 0 ? Math.min(...allValues) : 0.01;
    const range = maxValue - minValue;
    const padding = range > 0 ? range * 0.2 : 0.005; // 20% padding or minimum 0.5%

    if (ctrChart) {
      ctrChart.data = ctrData;
      ctrChart.options.scales.y.min = Math.max(0, minValue - padding);
      ctrChart.options.scales.y.max = Math.min(0.15, maxValue + padding); // Cap at 15% max
      ctrChart.update();
    } else {
      ctrChart = new Chart(document.getElementById('ctrChart'), {
        type: 'line',
        data: ctrData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: (ctx) => (ctx.parsed.y * 100).toFixed(2) + '% CTR'
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              min: Math.max(0, minValue - padding),
              max: Math.min(0.15, maxValue + padding), // Dynamic max, capped at 15%
              title: { display: true, text: 'CTR (Click-Through Rate)' },
              ticks: {
                callback: (v) => (v * 100).toFixed(1) + '%'
              }
            },
            x: {
              title: { display: true, text: 'Days' }
            }
          }
        }
      });
    }
  }

  async function initializeCTRChart() {
    try {
      // Fetch real CTR data - will be updated when loadMLDashboard completes
      // If no data available yet, show fallback
      setTimeout(() => {
        if (!ctrChart) {
          initializeFallbackChart();
        }
      }, 2000);
    } catch (error) {
      console.error('Failed to initialize CTR chart:', error);
      initializeFallbackChart();
    }
  }

  function initializeFallbackChart() {
    const ctrData = {
      labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
      datasets: [
        {
          label: 'MAB Algorithm',
          data: [0.021, 0.023, 0.025, 0.024, 0.026, 0.028, 0.027],
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13, 110, 253, 0.1)',
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6
        },
        {
          label: 'Random Baseline',
          data: [0.015, 0.016, 0.017, 0.016, 0.018, 0.019, 0.018],
          borderColor: '#6c757d',
          backgroundColor: 'rgba(108, 117, 125, 0.1)',
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6
        }
      ]
    };

    ctrChart = new Chart(document.getElementById('ctrChart'), {
      type: 'line',
      data: ctrData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (ctx) => (ctx.parsed.y * 100).toFixed(2) + '% CTR'
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            min: 0.01,
            max: 0.035,
            title: { display: true, text: 'CTR (Click-Through Rate)' },
            ticks: {
              callback: (v) => (v * 100).toFixed(1) + '%'
            }
          },
          x: {
            title: { display: true, text: 'Days' }
          }
        }
      }
    });
  }


  let exploreChart = null;
  let sentimentChart = null;

  async function initializeExplorationChart(explorationData) {
    const ctx = document.getElementById('exploreChart');
    if (exploreChart) exploreChart.destroy();
    
    exploreChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Exploitation', 'Exploration'],
        datasets: [
          { 
            data: [explorationData?.exploitation || 77, explorationData?.exploration || 23], 
            backgroundColor: ['#28a745', '#ffc107'] 
          }
        ]
      },
      options: { 
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (ctx) => ctx.label + ': ' + ctx.parsed + '%'
            }
          }
        }
      }
    });
  }

  async function initializeSentimentChart(sentimentData) {
    const ctx = document.getElementById('sentimentChart');
    if (sentimentChart) sentimentChart.destroy();
    
    const total = (sentimentData?.positive || 0) + (sentimentData?.neutral || 0) + (sentimentData?.negative || 0);
    const positive = total > 0 ? Math.round(((sentimentData?.positive || 0) / total) * 100) : 65;
    const neutral = total > 0 ? Math.round(((sentimentData?.neutral || 0) / total) * 100) : 28;
    const negative = total > 0 ? Math.round(((sentimentData?.negative || 0) / total) * 100) : 7;
    
    sentimentChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Positive', 'Neutral', 'Negative'],
        datasets: [
          {
            label: 'Reviews (%)',
            data: [positive, neutral, negative],
            backgroundColor: ['#28a745', '#6c757d', '#dc3545']
          }
        ]
      },
      options: { 
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: { display: true, text: 'Percentage (%)' },
            ticks: {
              callback: (v) => v + '%'
            }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => ctx.parsed.y + '%'
            }
          }
        }
      }
    });
  }

  // Initialize charts
  loadMLDashboard().then(() => {
    initializeCTRChart();
  });
</script>
