<% layout('layouts/boilerplate') %>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
  }
  
  .map-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    border: 1px solid rgba(255,255,255,0.3);
  }
  
  #adminMap {
    width: 100%;
    height: 700px;
    border-radius: 15px;
    z-index: 1;
  }
  
  .admin-controls {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    border: 1px solid rgba(255,255,255,0.3);
  }
  
  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
  }
  
  .status-in-transit { background: #ffc107; color: #000; }
  .status-at-destination { background: #28a745; color: #fff; }
  .status-at-home { background: #6c757d; color: #fff; }
  .status-planning { background: #17a2b8; color: #fff; }
</style>

<div class="container my-4">
  <div class="admin-controls">
    <h2 class="mb-4">
      <i class="fa-solid fa-map-location-dot me-2"></i>Admin - All Users Location Map
    </h2>
    <p class="text-muted">View all users' live locations on the map. All location data is visible to admins regardless of privacy settings.</p>
    <button class="btn btn-primary" id="refreshAdminMap">
      <i class="fa-solid fa-sync-alt me-2"></i>Refresh All Locations
    </button>
  </div>
  
  <div class="map-container">
    <div id="adminMap"></div>
  </div>
</div>

<script>
  let adminMap;
  let adminMarkerCluster;
  let adminSocket;

  // Initialize admin map
  function initAdminMap() {
    adminMap = L.map('adminMap').setView([20.5937, 78.9629], 5);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(adminMap);
    
    adminMarkerCluster = L.markerClusterGroup({
        maxClusterRadius: 50,
        chunkedLoading: true
    });
    adminMap.addLayer(adminMarkerCluster);
    
    // Initialize Socket.IO
    adminSocket = io();
    adminSocket.on('connect', () => {
        console.log('Admin connected to server');
        adminSocket.emit('location:subscribe');
    });
    
    adminSocket.on('location:update', (data) => {
        console.log('Location update received:', data);
    });
    
    // Load all users with locations
    loadAllUserLocations();
  }

  // Load all users with location data
  async function loadAllUserLocations() {
    try {
        const response = await fetch('/admin/api/users/locations');
        const data = await response.json();
        
        if (data.success) {
            adminMarkerCluster.clearLayers();
            
            data.users.forEach(user => {
                if (!user.location?.coordinates) return;
                
                const [lon, lat] = user.location.coordinates;
                
                // Create marker
                const marker = L.marker([lat, lon]);
                
                // Status badge
                const statusClass = `status-${user.location.travelStatus || 'at-home'}`;
                const statusText = (user.location.travelStatus || 'at-home').replace('-', ' ');
                
                // Popup content
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h6 style="margin: 0 0 0.5rem 0;">
                            <strong>${user.username}</strong>
                            ${user.role === 'admin' ? '<span class="badge bg-warning text-dark ms-2">Admin</span>' : ''}
                        </h6>
                        <p style="margin: 0.25rem 0;">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </p>
                        <p style="margin: 0.5rem 0 0.25rem 0; font-size: 0.9rem; color: #666;">
                            <i class="fa-solid fa-map-marker-alt"></i> ${user.location.city || 'Unknown City'}
                        </p>
                        <p style="margin: 0.25rem 0; font-size: 0.85rem; color: #888;">
                            <i class="fa-solid fa-eye"></i> Privacy: ${user.location.visibility || 'hidden'}
                        </p>
                        <p style="margin: 0.25rem 0; font-size: 0.85rem; color: #888;">
                            <i class="fa-solid fa-clock"></i> Updated: ${user.location.lastUpdated ? new Date(user.location.lastUpdated).toLocaleString() : 'Never'}
                        </p>
                        <a href="/buddy/profile?userId=${user._id}" class="btn btn-sm btn-primary mt-2" style="width: 100%;">
                            View Profile
                        </a>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                adminMarkerCluster.addLayer(marker);
            });
        }
    } catch (error) {
        console.error('Error loading user locations:', error);
    }
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', () => {
    initAdminMap();
    
    document.getElementById('refreshAdminMap').addEventListener('click', () => {
        loadAllUserLocations();
    });
  });

  // Auto-refresh every 30 seconds
  setInterval(() => {
    loadAllUserLocations();
  }, 30000);
</script>

