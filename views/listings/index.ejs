<% layout("/layouts/boilerplate")%>

<style>
    #filters {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter {
        text-align: center;
        margin-top: 1.5rem;
        margin-left: 2rem;
        opacity: 0.6;
    }

    .filter:hover {
        opacity: 1;
        cursor: pointer;
    }

    .tax-info {
        display: none;
        margin-top: 0.5rem;
    }

    .tax-toggle {
        border: 1px solid black;
        border-radius: 1rem;
        height: 3rem;
        padding: 1rem;
        margin-left: 9rem;
        display: flex;
        align-items: center;
    }

    .card {
        margin-bottom: 2rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        z-index: 1;
        opacity: 0.6;
    }

    .card:hover {
        transform: scale(1.03);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        z-index: 10;
        opacity: 1;
        cursor: pointer;
    }

    .listing-container {
        margin-bottom: 5rem; /* space below for footer */
    }

    .old-price {
        color: red;
    }

    .new-price {
        font-weight: bold;
        color: green;
    }

    .cut-price {
        text-decoration: line-through;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in-out forwards;
    }

    .personalized-alert {
        animation: fadeIn 0.5s ease-in-out;
    }
    /* Personalization banner styling */
    .personalization-banner {
        background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 100%) !important; /* indigo-50 to slate-50 */
        border: 1px solid #e5e7eb !important; /* gray-200 */
        border-left: 4px solid #4f46e5 !important; /* indigo-600 */
        color: #111827; /* gray-900 */
        border-radius: 12px;
        transition: box-shadow 0.2s ease, transform 0.2s ease;
    }
    .personalization-banner:hover { box-shadow: 0 10px 25px rgba(79,70,229,0.12); transform: translateY(-1px); }
    .how-it-works { color: #4f46e5; text-decoration: underline; text-underline-offset: 2px; }
    .how-it-works:hover { color: #1d4ed8; }
</style>



<div id="filters" class="position-relative">
    <div class="alert d-flex align-items-center gap-3 mt-3 personalized-alert personalization-banner" role="alert">
        <div class="flex-grow-1">
            <strong>We personalize your search results.</strong>
            <span id="info-trigger" class="ms-2 how-it-works" style="cursor: help;">How it works</span>
        </div>
    </div>
    <!-- <div class="filter"><div><i class="fa-solid fa-fire"></i></div><p>Trending</p></div>
    <div class="filter"><div><i class="fa-solid fa-bed"></i></div><p>Rooms</p></div>
    <div class="filter"><div><i class="fa-solid fa-mountain-city"></i></div><p>Iconic Cities</p></div>
    <div class="filter"><div><i class="fa-solid fa-mountain-sun"></i></div><p>Mountains</p></div>
    <div class="filter"><div><i class="fa-brands fa-fort-awesome"></i></div><p>Castles</p></div>
    <div class="filter"><div><i class="fa-solid fa-person-swimming"></i></div><p>Amazing pools</p></div>
    <div class="filter"><div><i class="fa-solid fa-tents"></i></div><p>Camps</p></div>
    <div class="filter"><div><i class="fa-solid fa-cow"></i></div><p>Farms</p></div>
    <div class="filter"><div><i class="fa-solid fa-snowflake"></i></div><p>Arctic</p></div> -->

    <div class="tax-toggle mb-3 mt-4 d-flex align-items-center gap-3">
        <div class="form-check-reverse form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault">
            <label class="form-check-label" for="flexSwitchCheckDefault">Display total after taxes</label>
        </div>
        
        <button class="btn btn-gradient border-0 shadow-sm" data-bs-toggle="modal" data-bs-target="#whatIfModal" style="background: linear-gradient(135deg, #2B6CB0 0%, #38B2AC 100%); color: white; border-radius: 25px; padding: 10px 25px; font-weight: 600;">
            <i class="fa-solid fa-calculator me-2"></i> What If Explorer
        </button>
    </div>
</div>

<!-- What-If Modal -->
<div class="modal fade" id="whatIfModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #2B6CB0 0%, #38B2AC 100%); padding: 1.5rem;">
                <div>
                    <h5 class="modal-title mb-1" style="font-size: 1.5rem; font-weight: 700;">
                        <i class="fa-solid fa-calculator me-2"></i> What If Explorer
                    </h5>
                    <small class="opacity-90">Discover how adjusting your preferences unlocks new options</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4" style="background: #F7FAFC;">
                <div class="alert alert-info border-0 mb-4" style="background: linear-gradient(135deg, rgba(43, 108, 176, 0.1) 0%, rgba(56, 178, 172, 0.1) 100%); border-left: 4px solid #2B6CB0;">
                    <div class="d-flex align-items-start">
                        <i class="fa-solid fa-lightbulb fa-2x text-primary me-3"></i>
                        <div>
                            <strong class="d-block mb-1">How it works:</strong>
                            <p class="mb-0 small">Adjust your budget and date preferences to see how many more listings become available. Get personalized recommendations based on your changes!</p>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4 g-4">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100 whatif-card" style="border-radius: 15px; transition: all 0.3s ease; border-top: 4px solid #2B6CB0;">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="icon-wrapper me-3" style="width: 60px; height: 60px; border-radius: 12px; background: linear-gradient(135deg, #2B6CB0 0%, #3182CE 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                        <i class="fa-solid fa-wallet"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fw-bold" style="color: #1A202C;">Budget Flexibility</h6>
                                        <small class="text-muted">Adjust your spending range</small>
                                    </div>
                                </div>
                                <label class="form-label fw-bold small text-uppercase" style="color: #2B6CB0; letter-spacing: 0.5px;">Your Max Nightly Budget</label>
                                <div class="input-group mb-3">
                                    <span class="input-group-text" style="background: #f7fafc; border-color: #e9ecef;">
                                        <i class="fa-solid fa-rupee-sign"></i>
                                    </span>
                                    <input type="number" class="form-control" id="whatif-maxbudget" placeholder="3000" min="0" style="border-color: #e9ecef;">
                                </div>
                                <small class="text-muted d-block mb-3">
                                    <i class="fa-solid fa-info-circle me-1"></i> Your current maximum budget per night
                                </small>
                                <hr class="my-3">
                                <label class="form-label fw-bold small text-uppercase" style="color: #38B2AC; letter-spacing: 0.5px;">Increase Budget By</label>
                                <div class="input-group">
                                    <span class="input-group-text" style="background: #f7fafc; border-color: #e9ecef;">
                                        <i class="fa-solid fa-plus"></i>
                                    </span>
                                    <input type="number" class="form-control" id="whatif-budget" placeholder="5000" min="0" style="border-color: #e9ecef;">
                                </div>
                                <small class="text-muted d-block mt-2">
                                    <i class="fa-solid fa-lightbulb me-1"></i> Try increasing by ₹1000 - ₹10000 to see more options
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100 whatif-card" style="border-radius: 15px; transition: all 0.3s ease; border-top: 4px solid #38B2AC;">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="icon-wrapper me-3" style="width: 60px; height: 60px; border-radius: 12px; background: linear-gradient(135deg, #38B2AC 0%, #2B6CB0 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                        <i class="fa-solid fa-calendar-check"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fw-bold" style="color: #1A202C;">Date Flexibility</h6>
                                        <small class="text-muted">Open up your travel dates</small>
                                    </div>
                                </div>
                                <label class="form-label fw-bold small text-uppercase mb-3" style="color: #38B2AC; letter-spacing: 0.5px;">Enable Flexible Dates</label>
                                <div class="form-check form-switch form-switch-lg mb-3" style="background: #f7fafc; padding: 1rem; border-radius: 10px;">
                                    <input class="form-check-input" type="checkbox" id="whatif-flexible" style="width: 60px; height: 30px; cursor: pointer;" data-bs-toggle="tooltip" data-bs-placement="top" title="Click to see what flexible dates include">
                                    <label class="form-check-label ms-3 fw-bold" for="whatif-flexible" style="cursor: pointer; color: #1A202C;">
                                        <span id="flexibility-status">Disabled</span>
                                    </label>
                                </div>
                                <div id="flexibility-info" class="alert alert-light border-0 mb-0" style="background: rgba(43, 108, 176, 0.05); border-left: 3px solid #38B2AC !important; display: none;">
                                    <strong class="d-block mb-2" style="color: #2B6CB0;">
                                        <i class="fa-solid fa-calendar-alt me-2"></i>What Flexible Dates Include:
                                    </strong>
                                    <ul class="mb-0 small" style="color: #6c757d; padding-left: 1.2rem;">
                                        <li>Explore listings available ±3 days from your original dates</li>
                                        <li>Compare prices across different check-in days</li>
                                        <li>Find better deals by shifting your stay by a few days</li>
                                        <li>Access listings that might be fully booked on your exact dates</li>
                                        <li>Discover lower prices on alternative dates</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn w-100 btn-lg text-white fw-bold" onclick="runWhatIf()" style="background: linear-gradient(135deg, #2B6CB0 0%, #38B2AC 100%); border: none; border-radius: 12px; padding: 1rem; box-shadow: 0 8px 20px rgba(43, 108, 176, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 25px rgba(43, 108, 176, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px rgba(43, 108, 176, 0.3)';">
                    <i class="fa-solid fa-rocket me-2"></i> Explore Scenarios
                </button>
                
                <div id="whatif-results" class="mt-4"></div>
                <div id="flexible-calendar" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<style>
.whatif-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 30px rgba(43, 108, 176, 0.2) !important;
}

.form-switch-lg .form-check-input {
    width: 60px !important;
    height: 30px !important;
    background-color: #cbd5e0;
    border: none;
}

.form-switch-lg .form-check-input:checked {
    background-color: #38B2AC;
}

.form-switch-lg .form-check-input:focus {
    box-shadow: 0 0 0 0.2rem rgba(56, 178, 172, 0.25);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const flexibleToggle = document.getElementById('whatif-flexible');
    const flexibilityStatus = document.getElementById('flexibility-status');
    const flexibilityInfo = document.getElementById('flexibility-info');
    
    if (flexibleToggle) {
        flexibleToggle.addEventListener('change', function() {
            if (this.checked) {
                flexibilityStatus.textContent = 'Enabled';
                flexibilityStatus.style.color = '#38B2AC';
                flexibilityInfo.style.display = 'block';
            } else {
                flexibilityStatus.textContent = 'Disabled';
                flexibilityStatus.style.color = '#6c757d';
                flexibilityInfo.style.display = 'none';
            }
        });
        
        // Initialize tooltip
        if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
            new bootstrap.Tooltip(flexibleToggle, {
                title: 'Click to enable flexible dates and see what options become available',
                placement: 'top'
            });
        }
    }
});
</script>
</div>

<% if (allListings.length === 0) { %>
    <h4>No listings found for "<%= searchQuery %>"</h4>
<% } else { %>
    <div class="container mt-4 listing-container">
        <div id="listing-grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            <% allListings.forEach(listing => { 
                let priceWithGST = listing.price * 1.18;
            %>
                <div class="col">
                    <div class="card h-100 border-0 shadow-sm rounded-4" data-listing-id="<%= listing._id %>">
                        <a href="/listings/<%= listing._id %>" data-listing-id="<%= listing._id %>">
                            <div class="position-relative">
                                <img src="<%= listing.image?.url || '/images/default.jpg' %>" class="card-img-top rounded-top-4" style="height: 250px; object-fit: cover;" alt="<%= listing.title %>">
                                <% if (listing.performanceBadge) { %>
                                    <span class="position-absolute top-0 start-0 m-2 badge <%= listing.performanceBadge.class %>">
                                        <%= listing.performanceBadge.text %>
                                    </span>
                                <% } %>
                                <% if (listing.rankingScore) { %>
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <span class="badge bg-dark" title="Performance Score: <%= listing.rankingScore %>/100">
                                            <i class="fa-solid fa-chart-line"></i> <%= listing.rankingScore %>
                                        </span>
                                    </div>
                                <% } %>
                            </div>
                        </a>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title fw-bold mb-1"><%= listing.title %></h5>
                            <p class="mb-1 text-muted"><strong>Location:</strong> <%= listing.location %>, <%= listing.country %></p>
                            <p class="mb-2 text-muted">
                                <strong>Price:</strong> 
                                <span class="old-price" id="old-price-<%= listing._id %>">₹<%= listing.price %>/night</span>
                                <span class="tax-info new-price" id="new-price-<%= listing._id %>">₹<%= priceWithGST.toFixed(2) %>/night</span>
                            </p>
                            <% if (listing.performanceStatus && listing.performanceStatus !== 'average') { %>
                                <div class="performance-indicator mt-2">
                                    <small class="text-muted">
                                        <i class="fa-solid fa-<%= listing.performanceStatus === 'excellent' ? 'star' : (listing.performanceStatus === 'good' ? 'thumbs-up' : 'exclamation-triangle') %>"></i>
                                        Performance: <%= listing.performanceStatus.charAt(0).toUpperCase() + listing.performanceStatus.slice(1) %>
                                    </small>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% }); %>
        </div>
    </div>
<% } %>

<script>
    // Initialize tooltip and cleanup on page load
    window.addEventListener('DOMContentLoaded', function() {
        // Remove duplicate alerts
        const alerts = document.querySelectorAll('.personalized-alert');
        for (let i = 1; i < alerts.length; i++) {
            alerts[i].remove();
        }
        
        // Initialize Bootstrap tooltip
        const infoTrigger = document.getElementById('info-trigger');
        if (infoTrigger && typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
            new bootstrap.Tooltip(infoTrigger, {
                html: true,
                placement: 'bottom',
                title: '<strong>About personalized results</strong><br><br>We prioritize listings using recent browsing activity and preferences like budget and locations you open most. The order can change as you explore so newer, relevant options are surfaced. Your account activity is used only to improve your experience.',
                trigger: 'hover',
                animation: true
            });
        }
    });

    let taxSwitch = document.getElementById("flexSwitchCheckDefault");

    taxSwitch.addEventListener("click", () => {
        let allOldPrices = document.getElementsByClassName("old-price");
        let allNewPrices = document.getElementsByClassName("tax-info");

        for (let i = 0; i < allOldPrices.length; i++) {
            let oldPrice = allOldPrices[i];
            let newPrice = allNewPrices[i];

            // Toggle the line-through for old price and show the new price with GST
            if (taxSwitch.checked) {
                oldPrice.classList.add("cut-price");
                newPrice.style.display = "inline";
            } else {
                oldPrice.classList.remove("cut-price");
                newPrice.style.display = "none";
            }
        }
    });
</script>
<script>
    // Client-side re-ranking using bandit API with explanations
    (async function applyPersonalizedRanking(){
        try {
            const grid = document.getElementById('listing-grid');
            if (!grid) return;
            const cards = Array.from(grid.querySelectorAll('.card[data-listing-id]'));
            const listingIds = cards.map(c => c.getAttribute('data-listing-id'));
            if (listingIds.length === 0) return;

            const query = '<%= searchQuery %>';
            const resp = await fetch('/api/search/rank', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ listingIds, searchFilters: {}, query })
            });
            if (!resp.ok) return;
            const data = await resp.json();
            if (!data || !Array.isArray(data.ranked)) return;

            // Build map from id to column node for stable re-insertion
            const colById = new Map();
            cards.forEach(card => {
                const id = card.getAttribute('data-listing-id');
                colById.set(id, card.closest('.col'));
            });

            // Reorder DOM and add explanation badges
            const fragment = document.createDocumentFragment();
            data.ranked.forEach((item, idx) => {
                const id = (item && item._id) ? item._id : String(item);
                const col = colById.get(String(id));
                if (col) {
                    const explanation = data.explanations && data.explanations[String(id)];
                    if (explanation && idx < 3) {
                        const card = col.querySelector('.card');
                        if (card) {
                            const explEl = document.createElement('div');
                            explEl.className = 'position-absolute top-0 end-0 m-2';
                            explEl.innerHTML = `
                                <button class="btn btn-sm btn-info" data-bs-toggle="tooltip" data-bs-html="true" 
                                    title="<strong>Why recommended:</strong><br>
                                    ${(explanation.factors || []).map(f => '• ' + f.message).join('<br>')}<br>
                                    <em>Confidence: ${explanation.confidence}</em>">
                                    <i class="fa-solid fa-sparkles"></i> Recommended
                                </button>`;
                            card.appendChild(explEl);
                            if (window.bootstrap) new bootstrap.Tooltip(explEl);
                        }
                    }
                    fragment.appendChild(col);
                }
            });
            grid.appendChild(fragment);
        } catch (_) {}
    })();

    // What-If Functions
    function toggleWhatIf() {
        const modalEl = document.getElementById('whatIfModal');
        if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        } else {
            console.error('Bootstrap Modal not available');
            alert('Please wait for the page to fully load');
        }
    }

    async function runWhatIf() {
        const maxBudget = document.getElementById('whatif-maxbudget').value;
        const budget = document.getElementById('whatif-budget').value;
        const flexible = document.getElementById('whatif-flexible').checked;
        const resultsDiv = document.getElementById('whatif-results');
        const calendarDiv = document.getElementById('flexible-calendar');
        
        resultsDiv.innerHTML = '<div class="spinner-border text-primary"></div><p class="text-center mt-2">Analyzing scenarios...</p>';
        calendarDiv.innerHTML = '';
        
        try {
            const resp = await fetch('/api/search/whatif', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    baseResults: [],
                    proposedChanges: {
                        maxBudget: maxBudget ? parseFloat(maxBudget) : null,
                        budgetIncrease: budget ? parseFloat(budget) : null,
                        flexibleDates: flexible
                    }
                })
            });
            const data = await resp.json();
            if (data.success && data.suggestions) {
                // Fetch listings with their prices to filter by scenario
                const grid = document.getElementById('listing-grid');
                const cards = Array.from(grid.querySelectorAll('.card[data-listing-id]'));
                const allListings = cards.map(c => {
                    const cardBody = c.querySelector('.card-body');
                    const title = cardBody ? cardBody.querySelector('h5')?.textContent || 'Listing' : 'Listing';
                    // Try to extract price from the price span
                    const priceText = c.querySelector('.old-price')?.textContent || '';
                    const priceMatch = priceText.match(/₹?([\d,]+)/);
                    const price = priceMatch ? parseInt(priceMatch[1].replace(/,/g, '')) : 0;
                    return { title, price };
                });
                
                resultsDiv.innerHTML = data.suggestions.map((s, idx) => {
                    // Filter listings based on the scenario
                    let applicableListings = [];
                    
                    if (s.type === 'budget' && (maxBudget || budget)) {
                        const newBudgetMax = (maxBudget ? parseFloat(maxBudget) : 0) + (budget ? parseFloat(budget) : 0);
                        applicableListings = allListings.filter(l => l.price <= newBudgetMax && l.price > 0);
                    } else if (s.type === 'flexibility' || s.type === 'flexible') {
                        // For flexibility, show all affordable listings
                        const budgetLimit = (maxBudget ? parseFloat(maxBudget) : 3000) + (budget ? parseFloat(budget) : 0);
                        applicableListings = allListings.filter(l => l.price <= budgetLimit && l.price > 0);
                    } else {
                        // Default: show listings within reasonable budget
                        const budgetLimit = (maxBudget ? parseFloat(maxBudget) : 3000) + (budget ? parseFloat(budget) : 0);
                        applicableListings = allListings.filter(l => l.price <= budgetLimit && l.price > 0).slice(0, 5);
                    }
                    
                    return `
                        <div class="alert border-0 shadow-sm fade-in mb-3" role="alert" style="background: ${s.impact === 'positive' ? 'linear-gradient(135deg, rgba(56, 178, 172, 0.1) 0%, rgba(43, 108, 176, 0.1) 100%)' : 'linear-gradient(135deg, rgba(43, 108, 176, 0.1) 0%, rgba(56, 178, 172, 0.1) 100%)'}; border-left: 4px solid ${s.impact === 'positive' ? '#38B2AC' : '#2B6CB0'} !important; animation-delay: ${idx * 0.1}s; border-radius: 12px;">
                            <div class="d-flex align-items-start">
                                <div class="icon-wrapper me-3" style="width: 50px; height: 50px; border-radius: 10px; background: ${s.impact === 'positive' ? 'linear-gradient(135deg, #38B2AC, #2B6CB0)' : 'linear-gradient(135deg, #2B6CB0, #38B2AC)'}; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem; flex-shrink: 0;">
                                    <i class="fa-solid fa-${s.type === 'budget' ? 'wallet' : 'sliders'}"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <strong class="d-block mb-2" style="color: #1A202C; font-size: 1.1rem;">${s.message}</strong>
                                    ${s.examples && s.examples.length ? `
                                      <div class="mt-2 small" style="color: #6c757d;">
                                        <i class="fa-solid fa-info-circle me-1"></i>
                                        Examples under new budget: 
                                        ${s.examples.map(e => `<span class="badge bg-light text-dark ms-1">${e.title} (₹${e.price})</span>`).join('')}
                                      </div>` : ''}
                                    ${applicableListings.length > 0 ? `
                                    <div class="mt-3">
                                        <div class="fw-bold mb-2" style="color: #2B6CB0;"><i class="fa-solid fa-list me-1"></i> Applicable listings (${applicableListings.length}):</div>
                                        <div class="d-flex flex-wrap gap-2">
                                            ${applicableListings.slice(0, 8).map(listing => `
                                                <span class="badge p-2" style="background: white; color: #1A202C; border: 1px solid #e9ecef;">
                                                    <i class="fa-solid fa-building me-1" style="color: #2B6CB0;"></i>
                                                    ${listing.title}
                                                </span>
                                            `).join('')}
                                            ${applicableListings.length > 8 ? `<span class="badge p-2" style="background: linear-gradient(135deg, #2B6CB0, #38B2AC); color: white;">+${applicableListings.length - 8} more</span>` : ''}
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                                <span class="badge ms-2 align-self-start" style="background: ${s.impact === 'positive' ? 'linear-gradient(135deg, #38B2AC, #2B6CB0)' : 'linear-gradient(135deg, #2B6CB0, #38B2AC)'}; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600;">${s.impact === 'positive' ? 'Great Deal!' : 'Consider This'}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                resultsDiv.innerHTML = '<div class="alert alert-warning border-0 shadow-sm">No suggestions available at this time.</div>';
            }
            // If flexible is enabled, run real flexible-date search and render calendar
            if (flexible) {
                calendarDiv.innerHTML = '<div class="mt-3 small text-muted">Fetching real flexible-date savings...</div>';
                const today = new Date();
                const body = {
                    checkin: today.toISOString().slice(0,10),
                    nights: 2,
                    windowDays: 6,
                    maxBudget: maxBudget ? parseFloat(maxBudget) + (budget ? parseFloat(budget) : 0) : null
                };
                const flexResp = await fetch('/api/search/flexible', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const flexData = await flexResp.json();
                if (flexData && flexData.success) {
                    renderFlexibleCalendar(flexData);
                }
            }
        } catch(e) {
            resultsDiv.innerHTML = '<div class="alert alert-danger">Failed to fetch suggestions.</div>';
        }
    }

    function renderFlexibleCalendar(flex) {
        const cal = document.getElementById('flexible-calendar');
        if (!flex || !Array.isArray(flex.results)) return;

        // If nothing available, seed with friendly demo data so UI isn't empty
        const hasReal = flex.results.some(r => r.availableCount > 0 && r.minPrice !== null);
        let results = flex.results;
        let recommended = flex.recommended || [];
        if (!hasReal) {
            const today = new Date();
            results = Array.from({ length: 12 }).map((_, i) => {
                const start = new Date(today);
                start.setDate(start.getDate() + i + 1);
                const isCheap = i % 4 === 0;
                const isMid = i % 4 === 1;
                const price = isCheap ? 1999 : (isMid ? 3299 : 5899);
                const avail = isCheap ? 7 : (isMid ? 4 : 2);
                return {
                    date: start.toISOString().slice(0,10),
                    availableCount: avail,
                    minPrice: price
                };
            });
            recommended = results.slice(0,3).map(r => ({ date: r.date, minPrice: r.minPrice }));
        }

        const cells = results.map(r => {
            const price = r.minPrice;
            let bg = '#f8f9fa';
            if (price === null) bg = '#f1f5f9';
            else if (price < 2000) bg = '#d1fae5';
            else if (price < 4000) bg = '#bbf7d0';
            else if (price < 7000) bg = '#fde68a';
            else bg = '#fecaca';
            return `<div class="p-2 border rounded" style="min-width:100px;background:${bg}">
                        <div class="small text-muted">${r.date}</div>
                        <div class="fw-bold">${price === null ? '—' : '₹'+price}</div>
                        <div class="small">${r.availableCount} available</div>
                    </div>`;
        }).join('');
        const rec = (recommended||[]).map(r => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>${r.date} (${flex.nights} nights)</span>
                <span class="badge bg-success">₹${r.minPrice}</span>
            </li>
        `).join('');
        cal.innerHTML = `
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="mb-3">Flexible Dates — real savings</h6>
                    <div class="d-flex flex-wrap gap-2">${cells}</div>
                    ${rec ? `<h6 class="mt-4">Best options</h6><ul class="list-group list-group-flush">${rec}</ul>` : ''}
                    <div class="mt-3 text-end">
                        <button class="btn btn-outline-primary btn-sm" onclick="registerPriceWatch()">Notify me if a cheaper date appears</button>
                    </div>
                </div>
            </div>`;
    }

    async function registerPriceWatch(){
        try {
            const today = new Date();
            await fetch('/api/alerts/price-watch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ start: today.toISOString().slice(0,10), nights: 2 })
            });
            alert('We\'ll keep an eye out and notify you here about better prices.');
        } catch(_) { alert('Could not register price watch right now.'); }
    }
</script>
