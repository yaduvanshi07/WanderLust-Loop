<% layout("/layouts/boilerplate") %>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="performance-header">
        <h1 class="performance-title">Listing Performance Dashboard</h1>
        <p class="performance-subtitle">Monitor and improve your listing performance</p>
      </div>

      <!-- Performance Overview -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fa-solid fa-chart-line"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value"><%= listingPerformances.length %></div>
              <div class="metric-label">Total Listings</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fa-solid fa-star"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value">
                <%= listingPerformances.filter(lp => lp.performance.status === 'excellent').length %>
              </div>
              <div class="metric-label">Top Performers</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fa-solid fa-exclamation-triangle"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value">
                <%= listingPerformances.filter(lp => lp.performance.status === 'poor' || lp.performance.status === 'critical').length %>
              </div>
              <div class="metric-label">Need Attention</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fa-solid fa-trophy"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value">
                <%= Math.round(listingPerformances.reduce((sum, lp) => sum + lp.performance.metrics.performanceScore, 0) / listingPerformances.length) || 0 %>
              </div>
              <div class="metric-label">Avg Score</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notifications -->
      <% if (notifications && notifications.length > 0) { %>
        <div class="notifications-section mb-4">
          <h3 class="section-title">
            <i class="fa-solid fa-bell"></i> Performance Alerts
          </h3>
          <div class="notifications-list">
            <% notifications.forEach(notification => { %>
              <div class="notification-card alert alert-warning">
                <div class="notification-header">
                  <h6 class="notification-title">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    <%= notification.listingTitle %> needs attention
                  </h6>
                  <span class="notification-score">
                    Score: <%= notification.performance.metrics.performanceScore %>/100
                  </span>
                </div>
                <p class="notification-message">
                  Your listing is not attracting enough users. Consider the recommendations below to improve performance.
                </p>
              </div>
            <% }); %>
          </div>
        </div>
      <% } %>

      <!-- Listing Performance Table -->
      <div class="performance-table-section">
        <h3 class="section-title">
          <i class="fa-solid fa-list"></i> Listing Performance Details
        </h3>
        
        <% if (listingPerformances && listingPerformances.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Listing</th>
                  <th>Performance Score</th>
                  <th>Status</th>
                  <th>Views</th>
                  <th>Clicks</th>
                  <th>Bookings</th>
                  <th>CTR</th>
                  <th>Recommendations</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% listingPerformances.forEach(({ listing, performance }) => { %>
                  <tr class="performance-row">
                    <td>
                      <div class="listing-info">
                        <div class="listing-image">
                          <img src="<%= listing.image?.url || '/images/default.jpg' %>" alt="<%= listing.title %>">
                        </div>
                        <div class="listing-details">
                          <div class="listing-title"><%= listing.title %></div>
                          <div class="listing-location">
                            <i class="fa-solid fa-location-dot"></i>
                            <%= listing.location %>
                          </div>
                        </div>
                      </div>
                    </td>
                    <td>
                      <div class="score-container">
                        <div class="score-circle score-<%= performance.status %>">
                          <%= performance.metrics.performanceScore %>
                        </div>
                        <div class="score-label">/100</div>
                      </div>
                    </td>
                    <td>
                      <span class="status-badge status-<%= performance.status %>">
                        <%= performance.status.charAt(0).toUpperCase() + performance.status.slice(1) %>
                      </span>
                    </td>
                    <td><%= performance.metrics.totalViews %></td>
                    <td><%= performance.metrics.totalClicks %></td>
                    <td><%= performance.metrics.totalBookings %></td>
                    <td><%= (performance.metrics.clickThroughRate * 100).toFixed(1) %>%</td>
                    <td>
                      <% if (performance.recommendations && performance.recommendations.length > 0) { %>
                        <div class="recommendations">
                          <% performance.recommendations.slice(0, 2).forEach(rec => { %>
                            <div class="recommendation-item">
                              <i class="fa-solid fa-<%= rec.priority === 'high' ? 'exclamation-circle' : 'info-circle' %>"></i>
                              <span class="recommendation-text"><%= rec.message %></span>
                            </div>
                          <% }); %>
                          <% if (performance.recommendations.length > 2) { %>
                            <small class="text-muted">+<%= performance.recommendations.length - 2 %> more</small>
                          <% } %>
                        </div>
                      <% } else { %>
                        <span class="text-success">No issues found</span>
                      <% } %>
                    </td>
                    <td>
                      <div class="action-buttons">
                        <a href="/listings/<%= listing._id %>" class="btn btn-sm btn-outline-primary" title="View Listing">
                          <i class="fa-solid fa-eye"></i>
                        </a>
                        <a href="/listings/<%= listing._id %>/edit" class="btn btn-sm btn-outline-secondary" title="Edit Listing">
                          <i class="fa-solid fa-edit"></i>
                        </a>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="no-listings">
            <div class="no-listings-icon">
              <i class="fa-solid fa-home"></i>
            </div>
            <h3>No listings found</h3>
            <p>You don't have any listings yet. Create your first listing to start tracking performance.</p>
            <a href="/listings/new" class="btn btn-primary">
              <i class="fa-solid fa-plus"></i> Create Listing
            </a>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<style>
.performance-header {
  text-align: center;
  margin-bottom: 40px;
}

.performance-title {
  font-size: 32px;
  font-weight: 700;
  color: #222;
  margin-bottom: 8px;
}

.performance-subtitle {
  font-size: 18px;
  color: #717171;
  margin: 0;
}

.metric-card {
  background: white;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  gap: 16px;
  height: 100%;
}

.metric-icon {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  background: linear-gradient(135deg, #ff385c, #e31c5f);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 24px;
}

.metric-content {
  flex: 1;
}

.metric-value {
  font-size: 28px;
  font-weight: 700;
  color: #222;
  margin-bottom: 4px;
}

.metric-label {
  font-size: 14px;
  color: #717171;
  text-transform: uppercase;
  font-weight: 500;
}

.section-title {
  font-size: 24px;
  font-weight: 600;
  color: #222;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.notifications-section {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 12px;
  padding: 20px;
}

.notification-card {
  margin-bottom: 12px;
  border: none;
  border-radius: 8px;
}

.notification-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.notification-title {
  font-size: 16px;
  font-weight: 600;
  margin: 0;
  color: #856404;
}

.notification-score {
  font-size: 14px;
  font-weight: 600;
  color: #856404;
}

.notification-message {
  margin: 0;
  color: #856404;
}

.performance-table-section {
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  padding: 24px;
}

.table {
  margin: 0;
}

.table thead th {
  background: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
  font-weight: 600;
  color: #495057;
  padding: 16px 12px;
}

.table tbody td {
  padding: 16px 12px;
  vertical-align: middle;
  border-bottom: 1px solid #f0f0f0;
}

.listing-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.listing-image {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  overflow: hidden;
}

.listing-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.listing-details {
  flex: 1;
}

.listing-title {
  font-weight: 500;
  color: #222;
  margin-bottom: 4px;
}

.listing-location {
  font-size: 12px;
  color: #717171;
  display: flex;
  align-items: center;
  gap: 4px;
}

.score-container {
  display: flex;
  align-items: center;
  gap: 8px;
}

.score-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: white;
  font-size: 14px;
}

.score-excellent {
  background: #28a745;
}

.score-good {
  background: #17a2b8;
}

.score-average {
  background: #ffc107;
  color: #212529;
}

.score-poor {
  background: #fd7e14;
}

.score-critical {
  background: #dc3545;
}

.score-label {
  font-size: 12px;
  color: #717171;
}

.status-badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-excellent {
  background: #d4edda;
  color: #155724;
}

.status-good {
  background: #d1ecf1;
  color: #0c5460;
}

.status-average {
  background: #fff3cd;
  color: #856404;
}

.status-poor {
  background: #f8d7da;
  color: #721c24;
}

.status-critical {
  background: #f5c6cb;
  color: #721c24;
}

.recommendations {
  max-width: 200px;
}

.recommendation-item {
  display: flex;
  align-items: flex-start;
  gap: 6px;
  margin-bottom: 4px;
  font-size: 12px;
}

.recommendation-item i {
  color: #ffc107;
  margin-top: 2px;
}

.recommendation-text {
  color: #495057;
  line-height: 1.3;
}

.action-buttons {
  display: flex;
  gap: 4px;
}

.action-buttons .btn {
  padding: 6px 8px;
  font-size: 12px;
}

.no-listings {
  text-align: center;
  padding: 60px 20px;
}

.no-listings-icon {
  font-size: 64px;
  color: #717171;
  margin-bottom: 24px;
}

.no-listings h3 {
  font-size: 24px;
  font-weight: 600;
  color: #222;
  margin-bottom: 8px;
}

.no-listings p {
  color: #717171;
  margin-bottom: 24px;
}

@media (max-width: 768px) {
  .metric-card {
    flex-direction: column;
    text-align: center;
  }
  
  .listing-info {
    flex-direction: column;
    text-align: center;
  }
  
  .notification-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .table-responsive {
    font-size: 14px;
  }
}

</style>
