<% layout("/layouts/boilerplate") %>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="performance-header">
        <h1 class="performance-title">Listing Performance Dashboard</h1>
        <p class="performance-subtitle">Monitor and improve your listing performance</p>
      </div>

      <!-- Performance Overview -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fa-solid fa-chart-line"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value"><%= listingPerformances.length %></div>
              <div class="metric-label">Total Listings</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fa-solid fa-star"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value">
                <%= listingPerformances.filter(lp => lp.performance.status === 'excellent').length %>
              </div>
              <div class="metric-label">Top Performers</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fa-solid fa-exclamation-triangle"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value">
                <%= listingPerformances.filter(lp => lp.performance.status === 'poor' || lp.performance.status === 'critical').length %>
              </div>
              <div class="metric-label">Need Attention</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="metric-card">
            <div class="metric-icon">
              <i class="fa-solid fa-trophy"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value">
                <%= Math.round(listingPerformances.reduce((sum, lp) => sum + lp.performance.metrics.performanceScore, 0) / listingPerformances.length) || 0 %>
              </div>
              <div class="metric-label">Avg Score</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notifications -->
      <% if (notifications && notifications.length > 0) { %>
        <div class="notifications-section mb-4">
          <h3 class="section-title">
            <i class="fa-solid fa-bell"></i> Performance Alerts
          </h3>
          <div class="notifications-list">
            <% notifications.forEach(notification => { %>
              <div class="notification-card alert alert-warning">
                <div class="notification-header">
                  <h6 class="notification-title">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    <%= notification.listingTitle %> needs attention
                  </h6>
                  <span class="notification-score">
                    Score: <%= notification.performance.metrics.performanceScore %>/100
                  </span>
                </div>
                <p class="notification-message">
                  Your listing is not attracting enough users. Consider the recommendations below to improve performance.
                </p>
              </div>
            <% }); %>
          </div>
        </div>
      <% } %>

      <!-- Listing Performance Table -->
      <div class="performance-table-section">
        <h3 class="section-title">
          <i class="fa-solid fa-list"></i> Listing Performance Details
        </h3>
        
        <% if (listingPerformances && listingPerformances.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Listing</th>
                  <th>Performance Score</th>
                  <th>Status</th>
                  <th>Views</th>
                  <th>Clicks</th>
                  <th>Bookings</th>
                  <th>CTR</th>
                  <th>Recommendations</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% listingPerformances.forEach(({ listing, performance }) => { %>
                  <tr class="performance-row">
                    <td>
                      <div class="listing-info">
                        <div class="listing-image">
                          <img src="<%= listing.image?.url || '/images/default.jpg' %>" alt="<%= listing.title %>">
                        </div>
                        <div class="listing-details">
                          <div class="listing-title"><%= listing.title %></div>
                          <div class="listing-location">
                            <i class="fa-solid fa-location-dot"></i>
                            <%= listing.location %>
                          </div>
                        </div>
                      </div>
                    </td>
                    <td>
                      <div class="score-container">
                        <div class="score-circle score-<%= performance.status %>">
                          <%= performance.metrics.performanceScore %>
                        </div>
                        <div class="score-label">/100</div>
                      </div>
                    </td>
                    <td>
                      <span class="status-badge status-<%= performance.status %>">
                        <%= performance.status.charAt(0).toUpperCase() + performance.status.slice(1) %>
                      </span>
                    </td>
                    <td><%= performance.metrics.totalViews %></td>
                    <td><%= performance.metrics.totalClicks %></td>
                    <td><%= performance.metrics.totalBookings %></td>
                    <td><%= (performance.metrics.clickThroughRate * 100).toFixed(1) %>%</td>
                    <td>
                      <% if (performance.recommendations && performance.recommendations.length > 0) { %>
                        <div class="recommendations">
                          <% performance.recommendations.slice(0, 2).forEach(rec => { %>
                            <div class="recommendation-item">
                              <i class="fa-solid fa-<%= rec.priority === 'high' ? 'exclamation-circle' : 'info-circle' %>"></i>
                              <span class="recommendation-text"><%= rec.message %></span>
                            </div>
                          <% }); %>
                          <% if (performance.recommendations.length > 2) { %>
                            <small class="text-muted">+<%= performance.recommendations.length - 2 %> more</small>
                          <% } %>
                        </div>
                      <% } else { %>
                        <span class="text-success">No issues found</span>
                      <% } %>
                    </td>
                    <td>
                      <div class="action-buttons">
                        <a href="/listings/<%= listing._id %>" class="btn btn-sm btn-outline-primary" title="View Listing">
                          <i class="fa-solid fa-eye"></i>
                        </a>
                        <a href="/listings/<%= listing._id %>/edit" class="btn btn-sm btn-outline-secondary" title="Edit Listing">
                          <i class="fa-solid fa-edit"></i>
                        </a>
                        <button class="btn btn-sm btn-outline-info" title="What-If Explorer" onclick="openWhatIfModal('<%= listing._id %>', '<%= listing.title %>', <%= listing.price %>)">
                          <i class="fa-solid fa-sliders"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="no-listings">
            <div class="no-listings-icon">
              <i class="fa-solid fa-home"></i>
            </div>
            <h3>No listings found</h3>
            <p>You don't have any listings yet. Create your first listing to start tracking performance.</p>
            <a href="/listings/new" class="btn btn-primary">
              <i class="fa-solid fa-plus"></i> Create Listing
            </a>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<style>
.performance-header {
  text-align: center;
  margin-bottom: 40px;
}

.performance-title {
  font-size: 32px;
  font-weight: 700;
  color: #222;
  margin-bottom: 8px;
}

.performance-subtitle {
  font-size: 18px;
  color: #717171;
  margin: 0;
}

.metric-card {
  background: white;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  gap: 16px;
  height: 100%;
}

.metric-icon {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  background: linear-gradient(135deg, #ff385c, #e31c5f);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 24px;
}

.metric-content {
  flex: 1;
}

.metric-value {
  font-size: 28px;
  font-weight: 700;
  color: #222;
  margin-bottom: 4px;
}

.metric-label {
  font-size: 14px;
  color: #717171;
  text-transform: uppercase;
  font-weight: 500;
}

.section-title {
  font-size: 24px;
  font-weight: 600;
  color: #222;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.notifications-section {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 12px;
  padding: 20px;
}

.notification-card {
  margin-bottom: 12px;
  border: none;
  border-radius: 8px;
}

.notification-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.notification-title {
  font-size: 16px;
  font-weight: 600;
  margin: 0;
  color: #856404;
}

.notification-score {
  font-size: 14px;
  font-weight: 600;
  color: #856404;
}

.notification-message {
  margin: 0;
  color: #856404;
}

.performance-table-section {
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  padding: 24px;
}

.table {
  margin: 0;
}

.table thead th {
  background: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
  font-weight: 600;
  color: #495057;
  padding: 16px 12px;
}

.table tbody td {
  padding: 16px 12px;
  vertical-align: middle;
  border-bottom: 1px solid #f0f0f0;
}

.listing-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.listing-image {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  overflow: hidden;
}

.listing-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.listing-details {
  flex: 1;
}

.listing-title {
  font-weight: 500;
  color: #222;
  margin-bottom: 4px;
}

.listing-location {
  font-size: 12px;
  color: #717171;
  display: flex;
  align-items: center;
  gap: 4px;
}

.score-container {
  display: flex;
  align-items: center;
  gap: 8px;
}

.score-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: white;
  font-size: 14px;
}

.score-excellent {
  background: #28a745;
}

.score-good {
  background: #17a2b8;
}

.score-average {
  background: #ffc107;
  color: #212529;
}

.score-poor {
  background: #fd7e14;
}

.score-critical {
  background: #dc3545;
}

.score-label {
  font-size: 12px;
  color: #717171;
}

.status-badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-excellent {
  background: #d4edda;
  color: #155724;
}

.status-good {
  background: #d1ecf1;
  color: #0c5460;
}

.status-average {
  background: #fff3cd;
  color: #856404;
}

.status-poor {
  background: #f8d7da;
  color: #721c24;
}

.status-critical {
  background: #f5c6cb;
  color: #721c24;
}

.recommendations {
  max-width: 200px;
}

.recommendation-item {
  display: flex;
  align-items: flex-start;
  gap: 6px;
  margin-bottom: 4px;
  font-size: 12px;
}

.recommendation-item i {
  color: #ffc107;
  margin-top: 2px;
}

.recommendation-text {
  color: #495057;
  line-height: 1.3;
}

.action-buttons {
  display: flex;
  gap: 4px;
}

.action-buttons .btn {
  padding: 6px 8px;
  font-size: 12px;
}

.no-listings {
  text-align: center;
  padding: 60px 20px;
}

.no-listings-icon {
  font-size: 64px;
  color: #717171;
  margin-bottom: 24px;
}

.no-listings h3 {
  font-size: 24px;
  font-weight: 600;
  color: #222;
  margin-bottom: 8px;
}

.no-listings p {
  color: #717171;
  margin-bottom: 24px;
}

@media (max-width: 768px) {
  .metric-card {
    flex-direction: column;
    text-align: center;
  }
  
  .listing-info {
    flex-direction: column;
    text-align: center;
  }
  
  .notification-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .table-responsive {
    font-size: 14px;
  }
}

/* What-If Modal Styles */
.whatif-modal-card {
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  padding: 20px;
  margin-bottom: 15px;
  transition: transform 0.2s;
}

.whatif-modal-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.15);
}

.metric-comparison {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid #eee;
}

.metric-comparison:last-child {
  border-bottom: none;
}

.metric-label {
  font-weight: 600;
  color: #555;
}

.metric-values {
  display: flex;
  gap: 20px;
  align-items: center;
}

.current-value {
  color: #666;
}

.predicted-value {
  color: #007bff;
  font-weight: 600;
}

.change-indicator {
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
}

.change-positive {
  background: #d4edda;
  color: #155724;
}

.change-negative {
  background: #f8d7da;
  color: #721c24;
}

.change-neutral {
  background: #e2e3e5;
  color: #383d41;
}
</style>

<!-- What-If Scenario Explorer Modal -->
<div class="modal fade" id="hostWhatIfModal" tabindex="-1" aria-labelledby="hostWhatIfModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="hostWhatIfModalLabel">
          <i class="fa-solid fa-sliders me-2"></i> Scenario Explorer
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <h6 id="modalListingTitle" class="text-muted">Listing: <span class="text-dark" id="listingName"></span></h6>
          <small id="modalListingId" class="text-muted"></small>
        </div>

        <!-- Scenario Inputs -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card h-100 border-primary">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="fa-solid fa-tag text-success me-2"></i> Price Scenario
                </h6>
                <div class="mb-2">
                  <label class="form-label small">Current Price (‚Çπ)</label>
                  <input type="text" class="form-control" id="currentPrice" readonly>
                </div>
                <div class="mb-2">
                  <label class="form-label small">New Price (‚Çπ)</label>
                  <input type="number" class="form-control" id="newPrice" placeholder="Enter new price" min="0">
                </div>
                <small class="text-muted">Change your listing price and see predicted impact</small>
              </div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="card h-100 border-warning">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="fa-solid fa-percent text-warning me-2"></i> Discount Scenario
                </h6>
                <div class="mb-2">
                  <label class="form-label small">Discount Type</label>
                  <select class="form-select form-select-sm" id="discountType">
                    <option value="percent">Percentage (%)</option>
                    <option value="fixed">Fixed Amount (‚Çπ)</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label small">Discount Amount</label>
                  <input type="number" class="form-control" id="discountAmount" placeholder="10" min="0" step="0.1">
                </div>
                <small class="text-muted">Offer discounts to attract more bookings</small>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card h-100 border-info">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="fa-solid fa-file-contract text-info me-2"></i> Policy Scenario
                </h6>
                <div class="mb-2">
                  <label class="form-label small">Cancellation Policy</label>
                  <select class="form-select form-select-sm" id="cancellationPolicy">
                    <option value="">None</option>
                    <option value="flexible">Flexible</option>
                    <option value="moderate">Moderate</option>
                    <option value="strict">Strict</option>
                  </select>
                </div>
                <small class="text-muted">See how policy affects bookings and cancellations</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Analyze Button -->
        <div class="text-center mb-4">
          <button class="btn btn-primary btn-lg" onclick="analyzeScenario()">
            <i class="fa-solid fa-calculator me-2"></i> Analyze Scenario
          </button>
        </div>

        <!-- Results Display -->
        <div id="scenarioResults" class="mt-4"></div>
      </div>
    </div>
  </div>
</div>

<script>
let currentListingId = null;
let currentListingPrice = null;

function openWhatIfModal(listingId, title, price) {
  currentListingId = listingId;
  currentListingPrice = price;
  
  document.getElementById('listingName').textContent = title;
  document.getElementById('modalListingId').textContent = `ID: ${listingId}`;
  document.getElementById('currentPrice').value = `‚Çπ${price.toLocaleString()}`;
  document.getElementById('newPrice').value = '';
  document.getElementById('discountAmount').value = '';
  document.getElementById('cancellationPolicy').value = '';
  document.getElementById('scenarioResults').innerHTML = '';
  
  const modal = new bootstrap.Modal(document.getElementById('hostWhatIfModal'));
  modal.show();
}

async function analyzeScenario() {
  const resultsDiv = document.getElementById('scenarioResults');
  resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div><p class="mt-2">Analyzing scenario...</p></div>';

  const newPrice = document.getElementById('newPrice').value;
  const discountAmount = document.getElementById('discountAmount').value;
  const discountType = document.getElementById('discountType').value;
  const cancellationPolicy = document.getElementById('cancellationPolicy').value;

  const scenarios = {};
  
  if (newPrice) {
    scenarios.price = { newPrice: parseFloat(newPrice) };
  }
  
  if (discountAmount) {
    scenarios.discount = { 
      discountPercent: parseFloat(discountAmount), 
      discountType 
    };
  }
  
  if (cancellationPolicy) {
    scenarios.policy = { newPolicy: cancellationPolicy };
  }

  if (Object.keys(scenarios).length === 0) {
    resultsDiv.innerHTML = '<div class="alert alert-warning">Please select at least one scenario to analyze.</div>';
    return;
  }

  try {
    const response = await fetch('/api/host/whatif', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ listingId: currentListingId, scenarios })
    });

    const data = await response.json();
    
    if (data.success && data.data) {
      displayScenarioResults(data.data);
    } else {
      resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Could not analyze scenario'}</div>`;
    }
  } catch (error) {
    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
  }
}

function displayScenarioResults(analysis) {
  const resultsDiv = document.getElementById('scenarioResults');
  let html = '<div class="card border-0 shadow-sm">';
  
  // Header
  html += '<div class="card-header bg-light"><h5 class="mb-0">Scenario Analysis Results</h5></div>';
  html += '<div class="card-body">';

  // Price Scenario
  if (analysis.scenarios.price) {
    const price = analysis.scenarios.price;
    html += '<div class="whatif-modal-card border-start border-success border-4">';
    html += '<h6><i class="fa-solid fa-tag text-success me-2"></i>Price Impact</h6>';
    html += `<p>Changing price from ‚Çπ${price.currentPrice.toLocaleString()} to ‚Çπ${price.newPrice.toLocaleString()} (${price.priceChange > 0 ? '+' : ''}${price.priceChange.toFixed(1)}%)</p>`;
    
    html += displayMetricComparison('Views', price.impact.views, 'üëÅÔ∏è');
    html += displayMetricComparison('Bookings', price.impact.bookings, 'üìÖ');
    html += displayMetricComparison('Revenue (‚Çπ)', price.impact.revenue, 'üí∞');
    
    html += `<p class="mt-3"><strong>Market Position:</strong> ${price.marketPosition}</p>`;
    html += `<p class="text-info"><i class="fa-solid fa-lightbulb me-2"></i>${price.recommendation}</p>`;
    html += '</div>';
  }

  // Discount Scenario
  if (analysis.scenarios.discount) {
    const discount = analysis.scenarios.discount;
    html += '<div class="whatif-modal-card border-start border-warning border-4 mt-3">';
    html += '<h6><i class="fa-solid fa-percent text-warning me-2"></i>Discount Impact</h6>';
    html += `<p>Offering ${discount.discountType === 'percent' ? discount.discountPercent + '%' : '‚Çπ' + discount.discountAmount + ''} discount</p>`;
    
    html += displayMetricComparison('Bookings', discount.impact.bookings, 'üìÖ');
    html += displayMetricComparison('Revenue (‚Çπ)', discount.impact.revenue, 'üí∞');
    
    html += `<p class="text-success mt-3"><i class="fa-solid fa-chart-line me-2"></i>Estimated booking increase: ${discount.impact.estimatedBookingIncrease}%</p>`;
    html += '</div>';
  }

  // Policy Scenario
  if (analysis.scenarios.policy) {
    const policy = analysis.scenarios.policy;
    html += '<div class="whatif-modal-card border-start border-info border-4 mt-3">';
    html += '<h6><i class="fa-solid fa-file-contract text-info me-2"></i>Policy Impact</h6>';
    html += `<p>Changing from ${policy.currentPolicy} to ${policy.newPolicy} policy</p>`;
    
    html += displayMetricComparison('Bookings', policy.impact.bookings, 'üìÖ');
    
    html += `<div class="mt-2"><strong>Estimated Cancellation Rate:</strong> ${policy.impact.cancellationRate.predicted}%</div>`;
    html += '</div>';
  }

  // Overall Recommendation
  if (analysis.overallRecommendation) {
    html += '<div class="alert alert-info mt-3">';
    html += '<h6><i class="fa-solid fa-brain me-2"></i>Overall Recommendation</h6>';
    html += `<p class="mb-1">${analysis.overallRecommendation.summary}</p>`;
    html += `<p class="mb-0"><strong>Risk Level:</strong> <span class="badge bg-${getRiskColor(analysis.overallRecommendation.riskLevel)}">${analysis.overallRecommendation.riskLevel.toUpperCase()}</span></p>`;
    html += '</div>';
  }

  html += '</div></div>';
  resultsDiv.innerHTML = html;
}

function displayMetricComparison(label, metric, icon) {
  const changeClass = metric.changePercent > 0 ? 'change-positive' : 
                     metric.changePercent < 0 ? 'change-negative' : 'change-neutral';
  const arrow = metric.changePercent > 0 ? '‚ÜóÔ∏è' : 
                metric.changePercent < 0 ? '‚ÜòÔ∏è' : '‚Üí';
  
  return `
    <div class="metric-comparison">
      <span class="metric-label">${icon} ${label}</span>
      <div class="metric-values">
        <span class="current-value">Current: ${metric.current}</span>
        <span class="predicted-value">Predicted: ${metric.predicted}</span>
        <span class="change-indicator ${changeClass}">
          ${arrow} ${metric.change} (${metric.changePercent > 0 ? '+' : ''}${metric.changePercent.toFixed(1)}%)
        </span>
      </div>
    </div>
  `;
}

function getRiskColor(level) {
  if (level === 'low') return 'success';
  if (level === 'medium') return 'warning';
  return 'danger';
}
</script>
